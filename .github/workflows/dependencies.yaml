name: Dependency Update

on:
  schedule:
    - cron: '0 9 * * 1' # Weekly on Monday at 9 AM UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  update-dependencies:
    name: Update Go Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Check for outdated dependencies
        id: check-deps
        run: |
          echo "Checking for outdated dependencies..."
          go list -u -m all > current-deps.txt
          
          # Check if there are any outdated dependencies
          OUTDATED=$(go list -u -m all | grep -v "=>" | grep "\[" | wc -l)
          echo "outdated_count=$OUTDATED" >> $GITHUB_OUTPUT
          
          if [ $OUTDATED -gt 0 ]; then
            echo "Found $OUTDATED outdated dependencies"
            go list -u -m all | grep -v "=>" | grep "\["
          else
            echo "All dependencies are up to date"
          fi

      - name: Update dependencies
        if: steps.check-deps.outputs.outdated_count > 0
        run: |
          echo "Updating dependencies..."
          
          # Update all dependencies to latest minor/patch versions
          go get -u ./...
          
          # Tidy up
          go mod tidy
          
          # Verify the build still works
          go build ./...

      - name: Run tests after update
        if: steps.check-deps.outputs.outdated_count > 0
        run: |
          # Generate code first
          go generate -skip="mockgen" ./...
          go generate -run="mockgen" ./...
          
          # Create tmp directory for coverage
          mkdir -p tmp
          
          # Run tests to ensure updates don't break anything
          GO_ENV=test go test -v ./...

      - name: Check for security vulnerabilities
        if: steps.check-deps.outputs.outdated_count > 0
        run: |
          # Install govulncheck if not available
          go install golang.org/x/vuln/cmd/govulncheck@latest
          
          # Check for vulnerabilities
          govulncheck ./...

      - name: Generate update summary
        if: steps.check-deps.outputs.outdated_count > 0
        id: summary
        run: |
          echo "## Dependency Updates" > update-summary.md
          echo "" >> update-summary.md
          echo "The following dependencies have been updated:" >> update-summary.md
          echo "" >> update-summary.md
          
          # Show diff of go.mod
          if git diff --name-only | grep -q "go.mod"; then
            echo "### go.mod changes:" >> update-summary.md
            echo "\`\`\`diff" >> update-summary.md
            git diff go.mod >> update-summary.md
            echo "\`\`\`" >> update-summary.md
            echo "" >> update-summary.md
          fi
          
          echo "### Verification" >> update-summary.md
          echo "- ✅ Build successful" >> update-summary.md
          echo "- ✅ Tests passing" >> update-summary.md
          echo "- ✅ No security vulnerabilities detected" >> update-summary.md
          echo "" >> update-summary.md
          echo "This PR was created automatically by the dependency update workflow." >> update-summary.md

      - name: Create Pull Request
        if: steps.check-deps.outputs.outdated_count > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          title: "chore: update Go dependencies"
          body-path: update-summary.md
          commit-message: "chore: update Go dependencies"
          branch: dependency-updates
          base: main
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Enable auto-merge for dependency updates
        if: steps.check-deps.outputs.outdated_count > 0
        run: |
          # Get the PR number from the previous step
          PR_NUMBER=$(gh pr list --state open --head dependency-updates --json number --jq '.[0].number')
          if [ ! -z "$PR_NUMBER" ]; then
            echo "Enabling auto-merge for PR #$PR_NUMBER"
            gh pr merge $PR_NUMBER --auto --squash
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
